<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Oligonucleotide MW Calculator</title>
  <style>
    :root {
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      color: #0f172a;
      background: #f8fafc;
    }
    body {
      margin: 0;
      padding: 0;
    }
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 20px 40px;
    }
    h1 {
      margin-top: 0;
      font-size: 1.75rem;
    }
    section {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.05);
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
    }
    textarea,
    input[type="number"],
    input[type="text"] {
      width: 100%;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 0.95rem;
      box-sizing: border-box;
      background: #f8fafc;
    }
    textarea {
      min-height: 90px;
      resize: vertical;
    }
    .grid {
      display: grid;
      gap: 14px;
    }
    .grid-3 {
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
    }
    .grid-2 {
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }
    button {
      background: #0ea5e9;
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(14, 165, 233, 0.25);
      transition: transform 0.05s ease, box-shadow 0.2s ease;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 8px 16px rgba(14, 165, 233, 0.2);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #e2e8f0;
      padding: 8px 10px;
      font-size: 0.9rem;
    }
    th {
      background: #f1f5f9;
      text-align: left;
    }
    .status {
      padding: 10px 12px;
      border-radius: 10px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .status.ok {
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    .status.error {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecdd3;
    }
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .summary {
      margin-top: 10px;
      font-size: 0.95rem;
      color: #334155;
    }
    .mono {
      font-family: "SFMono-Regular", Consolas, "Liberation Mono", monospace;
    }
    details {
      margin-top: 10px;
    }
    .small {
      font-size: 0.85rem;
      color: #475569;
    }
  </style>
</head>
<body>
<main>
  <h1>Oligonucleotide Molecular Weight Calculator</h1>
  <p class="small">Single-file, client-side calculator for IDT-style sequences with bases, backbone markers, and /.../ modification codes.</p>

  <section>
    <div class="grid grid-3">
      <div>
        <label for="sequence">Sequence (IDT notation)</label>
        <textarea id="sequence" placeholder="/5Phos/ATG*C*T"></textarea>
      </div>
      <div>
        <label for="waterLoss">Water loss per linkage (Da)</label>
        <input id="waterLoss" type="number" step="0.001" value="18.015" />
      </div>
      <div>
        <label for="psDelta">PS delta per linkage (Da)</label>
        <input id="psDelta" type="number" step="0.001" value="15.99" />
      </div>
      <div>
        <label for="omeDelta">2′-O-methyl delta vs RNA (Da)</label>
        <input id="omeDelta" type="number" step="0.001" value="14.03" />
      </div>
    </div>
    <div style="margin-top: 14px;" class="row">
      <button id="calculate">Calculate</button>
      <span id="status" class="status ok">Ready</span>
    </div>
  </section>

  <section>
    <h2 style="margin-top:0;">Mass Tables (editable JSON)</h2>
    <div class="grid grid-2">
      <div>
        <label for="dnaMasses">DNA residue masses</label>
        <textarea id="dnaMasses" class="mono" rows="5"></textarea>
      </div>
      <div>
        <label for="rnaMasses">RNA residue masses</label>
        <textarea id="rnaMasses" class="mono" rows="5"></textarea>
      </div>
      <div>
        <label for="lnaMasses">LNA residue masses (required for +A/+C/+G/+T)</label>
        <textarea id="lnaMasses" class="mono" rows="5"></textarea>
      </div>
      <div>
        <label for="pmoMasses">PMO residue masses (pA/pC/pG/pT)</label>
        <textarea id="pmoMasses" class="mono" rows="5"></textarea>
      </div>
      <div>
        <label for="modMasses">/code/ modification masses</label>
        <textarea id="modMasses" class="mono" rows="5"></textarea>
      </div>
    </div>
  </section>

  <section>
    <h2 style="margin-top:0;">Extinction coefficients (editable JSON)</h2>
    <div class="grid grid-2">
      <div>
        <label for="dnaExt">DNA residues (M⁻¹ cm⁻¹)</label>
        <textarea id="dnaExt" class="mono" rows="5"></textarea>
      </div>
      <div>
        <label for="rnaExt">RNA residues (M⁻¹ cm⁻¹)</label>
        <textarea id="rnaExt" class="mono" rows="5"></textarea>
      </div>
      <div>
        <label for="lnaExt">LNA residues (M⁻¹ cm⁻¹)</label>
        <textarea id="lnaExt" class="mono" rows="5"></textarea>
      </div>
      <div>
        <label for="pmoExt">PMO residues (M⁻¹ cm⁻¹)</label>
        <textarea id="pmoExt" class="mono" rows="5"></textarea>
      </div>
      <div>
        <label for="modExt">/code/ modifications (M⁻¹ cm⁻¹)</label>
        <textarea id="modExt" class="mono" rows="5"></textarea>
      </div>
    </div>
  </section>

  <section>
    <div class="row">
      <div>
        <div id="mwResult" style="font-size:1.25rem;font-weight:800;">Molecular weight: –</div>
        <div id="extResult" style="margin-top:4px;font-size:1.05rem;font-weight:700;">Extinction coefficient: –</div>
        <div id="summary" class="summary"></div>
      </div>
    </div>
    <details>
      <summary style="cursor:pointer;font-weight:700;">Show detailed breakdown</summary>
      <div id="breakdown"></div>
    </details>
  </section>

  <section>
    <h2 style="margin-top:0;">Sequence analysis</h2>
    <p class="small">N−1 deletion impurities (one monomer omitted) with recalculated molecular weights.</p>
    <div id="deletionAnalysis"></div>
  </section>
</main>

<script>
  const dnaMassesEl = document.getElementById('dnaMasses');
  const rnaMassesEl = document.getElementById('rnaMasses');
  const lnaMassesEl = document.getElementById('lnaMasses');
  const pmoMassesEl = document.getElementById('pmoMasses');
  const modMassesEl = document.getElementById('modMasses');
  const dnaExtEl = document.getElementById('dnaExt');
  const rnaExtEl = document.getElementById('rnaExt');
  const lnaExtEl = document.getElementById('lnaExt');
  const pmoExtEl = document.getElementById('pmoExt');
  const modExtEl = document.getElementById('modExt');
  const seqEl = document.getElementById('sequence');
  const waterLossEl = document.getElementById('waterLoss');
  const psDeltaEl = document.getElementById('psDelta');
  const omeDeltaEl = document.getElementById('omeDelta');
  const statusEl = document.getElementById('status');
  const resultEl = document.getElementById('mwResult');
  const extResultEl = document.getElementById('extResult');
  const breakdownEl = document.getElementById('breakdown');
  const summaryEl = document.getElementById('summary');
  const deletionEl = document.getElementById('deletionAnalysis');

  const defaultDNA = {
    A: 313.21,
    C: 289.18,
    G: 329.21,
    T: 304.2
  };
  const defaultRNA = {
    A: 329.21,
    C: 305.18,
    G: 345.21,
    U: 306.17,
    fA: 309.18,
    fC: 400
  };
  const defaultModMasses = {
    "5Phos": 79.98,
    "56-FAM": 537.47,
    "3BHQ_1": 296.16,
    "iSp18": 244.36
  };

  // Phosphorodiamidate morpholino residues modeled from the morpholino backbone
  // reference (https://en.wikipedia.org/wiki/Morpholino_nucleic_acid).
  // Values below reflect the heavier morpholine + phosphorodiamidate linkage
  // versus deoxyribose, so the PMO monomers are slightly heavier than their DNA
  // counterparts.
  const defaultPMO = {
    pA: 330.33,
    pC: 306.29,
    pG: 346.32,
    pT: 321.30
  };

  const defaultDNAExt = {
    A: 15400,
    C: 7400,
    G: 11500,
    T: 8700
  };

  const defaultRNAExt = {
    A: 15200,
    C: 7200,
    G: 12000,
    U: 9600
  };

  const defaultPMOExt = {
    pA: 15400,
    pC: 7400,
    pG: 11500,
    pT: 8700
  };

  function initDefaults() {
    dnaMassesEl.value = JSON.stringify(defaultDNA, null, 2);
    rnaMassesEl.value = JSON.stringify(defaultRNA, null, 2);
    lnaMassesEl.value = JSON.stringify({}, null, 2);
    pmoMassesEl.value = JSON.stringify(defaultPMO, null, 2);
    modMassesEl.value = JSON.stringify(defaultModMasses, null, 2);
    dnaExtEl.value = JSON.stringify(defaultDNAExt, null, 2);
    rnaExtEl.value = JSON.stringify(defaultRNAExt, null, 2);
    lnaExtEl.value = JSON.stringify(defaultDNAExt, null, 2);
    pmoExtEl.value = JSON.stringify(defaultPMOExt, null, 2);
    modExtEl.value = JSON.stringify({}, null, 2);
    seqEl.value = '/5Phos/ATG*C*T';
  }

  function setStatus(message, ok = true) {
    statusEl.textContent = message;
    statusEl.classList.toggle('ok', ok);
    statusEl.classList.toggle('error', !ok);
  }

  function parseJsonInput(el, label) {
    try {
      return JSON.parse(el.value || '{}');
    } catch (err) {
      throw new Error(`${label} must be valid JSON`);
    }
  }

  function getTables() {
    const masses = {
      dna: parseJsonInput(dnaMassesEl, 'DNA masses'),
      rna: parseJsonInput(rnaMassesEl, 'RNA masses'),
      lna: parseJsonInput(lnaMassesEl, 'LNA masses'),
      pmo: parseJsonInput(pmoMassesEl, 'PMO masses'),
      mods: parseJsonInput(modMassesEl, 'Modification masses')
    };
    const ext = {
      dna: parseJsonInput(dnaExtEl, 'DNA extinction coefficients'),
      rna: parseJsonInput(rnaExtEl, 'RNA extinction coefficients'),
      lna: parseJsonInput(lnaExtEl, 'LNA extinction coefficients'),
      pmo: parseJsonInput(pmoExtEl, 'PMO extinction coefficients'),
      mods: parseJsonInput(modExtEl, 'Modification extinction coefficients')
    };

    return { masses, ext };
  }

  function parseSequence(seq, tables, deltas) {
    const clean = seq.replace(/\s+/g, '');
    const tokens = [];
    const psMarkers = [];
    let pendingPS = false;

    const sortedKeys = {
      dna: Object.keys(tables.masses.dna || {}).sort((a, b) => b.length - a.length),
      rna: Object.keys(tables.masses.rna || {}).sort((a, b) => b.length - a.length),
      lna: Object.keys(tables.masses.lna || {}).sort((a, b) => b.length - a.length),
      pmo: Object.keys(tables.masses.pmo || {}).sort((a, b) => b.length - a.length)
    };

    function addLink() {
      if (tokens.length > 0) {
        psMarkers.push(pendingPS);
      }
      pendingPS = false;
    }

    function tryMassMatch(scope, typeLabel, extScope = scope) {
      for (const key of sortedKeys[scope]) {
        if (clean.startsWith(key, i)) {
          const mass = tables.masses[scope][key];
          if (mass === undefined) continue;
          addLink();
          const ext = tables.ext[extScope]?.[key] ?? 0;
          tokens.push({ text: key, type: typeLabel, mass, extCoeff: ext, notes: `${typeLabel} residue (table lookup)` });
          i += key.length;
          return true;
        }
      }
      return false;
    }

    for (let i = 0; i < clean.length; ) {
      const char = clean[i];

      if (char === '*') {
        if (tokens.length === 0) {
          throw new Error('Leading * is not allowed');
        }
        if (pendingPS) {
          throw new Error('Duplicate * before a monomer');
        }
        pendingPS = true;
        i += 1;
        continue;
      }

      if (char === '/') {
        const end = clean.indexOf('/', i + 1);
        if (end === -1) {
          throw new Error('Unterminated /mod/ token');
        }
        const code = clean.slice(i + 1, end);
        if (!code) {
          throw new Error('Empty /mod/ token');
        }
        const mass = tables.masses.mods[code];
        if (mass === undefined) {
          throw new Error(`No mass found for /${code}/`);
        }
        addLink();
        const ext = tables.ext.mods[code] ?? 0;
        tokens.push({ text: `/${code}/`, type: 'Modification', mass, extCoeff: ext, notes: '/code/ modification' });
        i = end + 1;
        continue;
      }

      const nextTwo = clean.slice(i, i + 2);
      if (nextTwo.startsWith('r')) {
        const base = nextTwo[1];
        const mass = tables.masses.rna[base];
        if (mass === undefined) {
          throw new Error(`No RNA mass for ${nextTwo}`);
        }
        addLink();
        const ext = tables.ext.rna[base] ?? 0;
        tokens.push({ text: nextTwo, type: 'RNA', mass, extCoeff: ext, notes: 'RNA residue' });
        i += 2;
        continue;
      }

      if (nextTwo.startsWith('f')) {
        const base = nextTwo[1];
        const mass = tables.masses.rna[`f${base}`];
        if (mass === undefined) {
          throw new Error(`No fluorinated RNA mass for ${nextTwo}`);
        }
        addLink();
        const ext = tables.ext.rna[`f${base}`] ?? tables.ext.rna[base] ?? 0;
        tokens.push({ text: nextTwo, type: 'Fluoro-RNA', mass, extCoeff: ext, notes: 'Fluorinated RNA residue' });
        i += 2;
        continue;
      }

      if (nextTwo.startsWith('m')) {
        const base = nextTwo[1];
        const rnaMass = tables.masses.rna[base];
        if (rnaMass === undefined) {
          throw new Error(`No RNA mass for ${nextTwo}`);
        }
        const mass = rnaMass + deltas.ome;
        addLink();
        const ext = tables.ext.rna[base] ?? 0;
        tokens.push({ text: nextTwo, type: '2′-OMe', mass, extCoeff: ext, notes: `RNA + ${deltas.ome} Da` });
        i += 2;
        continue;
      }

      if (nextTwo.startsWith('+')) {
        const base = nextTwo[1];
        const mass = tables.masses.lna[base];
        if (mass === undefined) {
          throw new Error(`No LNA mass provided for +${base}`);
        }
        addLink();
        const ext = tables.ext.lna[base] ?? 0;
        tokens.push({ text: `+${base}`, type: 'LNA', mass, extCoeff: ext, notes: 'LNA residue' });
        i += 2;
        continue;
      }

      if (nextTwo.startsWith('p')) {
        const base = nextTwo[1];
        const mass = tables.masses.pmo[`p${base}`];
        if (mass === undefined) {
          throw new Error(`No PMO mass provided for p${base}`);
        }
        addLink();
        const ext = tables.ext.pmo[`p${base}`] ?? tables.ext.dna[base] ?? 0;
        tokens.push({ text: `p${base}`, type: 'PMO', mass, extCoeff: ext, notes: 'PMO residue' });
        i += 2;
        continue;
      }

      if (/^[ACGT]$/.test(char)) {
        const mass = tables.masses.dna[char];
        if (mass === undefined) {
          throw new Error(`No DNA mass for ${char}`);
        }
        addLink();
        const ext = tables.ext.dna[char] ?? 0;
        tokens.push({ text: char, type: 'DNA', mass, extCoeff: ext, notes: 'DNA residue' });
        i += 1;
        continue;
      }

      if (char === 'U') {
        throw new Error('Use rU for RNA uridine');
      }

      if (tryMassMatch('rna', 'RNA')) {
        continue;
      }

      if (tryMassMatch('dna', 'DNA')) {
        continue;
      }

      if (tryMassMatch('lna', 'LNA')) {
        continue;
      }

      if (tryMassMatch('pmo', 'PMO')) {
        continue;
      }

      throw new Error(`Unrecognized token starting at "${clean.slice(i, i + 4)}"`);
    }

    if (pendingPS) {
      throw new Error('Trailing * must precede a monomer');
    }

    return { tokens, psMarkers };
  }

  function computeMW(tokens, psMarkers, deltas) {
    let massSum = 0;
    tokens.forEach(t => massSum += t.mass);

    const linkageCount = Math.max(tokens.length - 1, 0);
    const waterLossTotal = linkageCount * deltas.waterLoss;
    const psCount = psMarkers.filter(Boolean).length;
    const psDeltaTotal = psCount * deltas.psDelta;

    const total = massSum - waterLossTotal + psDeltaTotal;
    return { total, linkageCount, psCount, waterLossTotal, psDeltaTotal };
  }

  function computeExtinction(tokens) {
    return tokens.reduce((sum, t) => sum + (t.extCoeff ?? 0), 0);
  }

  function renderBreakdown(tokens, psMarkers, totals, deltas, extinctionTotal) {
    if (tokens.length === 0) {
      breakdownEl.innerHTML = '<p class="small">No tokens parsed.</p>';
      summaryEl.textContent = '';
      return;
    }
    const rows = tokens.map((t, idx) => `
      <tr>
        <td>${idx + 1}</td>
        <td class="mono">${t.text}</td>
        <td>${t.type}</td>
        <td>${t.mass.toFixed(3)}</td>
        <td>${(t.extCoeff ?? 0).toFixed(0)}</td>
        <td>${t.notes}</td>
      </tr>`).join('');

    const psSummary = psMarkers.map((flag, idx) => flag ? `PS between ${idx + 1}-${idx + 2}` : null).filter(Boolean).join(', ');

    breakdownEl.innerHTML = `
      <table>
        <thead>
          <tr><th>#</th><th>Token</th><th>Type</th><th>Mass (Da)</th><th>Ext. (M⁻¹ cm⁻¹)</th><th>Notes</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <p class="small">${psSummary || 'No PS linkages noted.'}</p>
    `;

    const parts = [
      `Σ residues = ${tokens.reduce((a, t) => a + t.mass, 0).toFixed(3)} Da`,
      `− ${totals.waterLossTotal.toFixed(3)} Da (water loss; ${deltas.waterLoss} × ${totals.linkageCount})`,
      `+ ${totals.psDeltaTotal.toFixed(3)} Da (PS; ${deltas.psDelta} × ${totals.psCount})`
    ];

    summaryEl.textContent = `Monomers: ${tokens.length} | Linkages: ${totals.linkageCount} | PS: ${totals.psCount}. Equation: ${parts.join(' ')}. Extinction: ${extinctionTotal.toFixed(0)} M⁻¹ cm⁻¹`;
  }

  function buildDeletionVariants(tokens, psMarkers, deltas) {
    if (tokens.length <= 1) return [];

    return tokens.map((token, removeIdx) => {
      const variantTokens = tokens.filter((_, idx) => idx !== removeIdx);
      if (variantTokens.length === 0) {
        return null;
      }

      const variantPsMarkers = psMarkers.slice();
      if (variantPsMarkers.length) {
        const spliceIndex = Math.max(removeIdx - 1, 0);
        variantPsMarkers.splice(spliceIndex, 1);
      }

      const totals = computeMW(variantTokens, variantPsMarkers, deltas);

      return {
        removeIdx,
        removedText: token.text,
        removedType: token.type,
        totals
      };
    }).filter(Boolean);
  }

  function renderDeletionAnalysis(tokens, psMarkers, totals, deltas) {
    if (tokens.length <= 1) {
      deletionEl.innerHTML = '<p class="small">Enter two or more monomers to view N−1 deletion results.</p>';
      return;
    }

    const variants = buildDeletionVariants(tokens, psMarkers, deltas);
    const rows = variants.map(v => {
      const delta = v.totals.total - totals.total;
      return `
        <tr>
          <td>${v.removeIdx + 1}</td>
          <td class="mono">${v.removedText}</td>
          <td>${v.removedType}</td>
          <td>${v.totals.total.toFixed(3)}</td>
          <td>${delta >= 0 ? '+' : ''}${delta.toFixed(3)}</td>
        </tr>`;
    }).join('');

    deletionEl.innerHTML = `
      <table>
        <thead>
          <tr><th>Removed position</th><th>Token</th><th>Type</th><th>MW (Da)</th><th>Δ vs full (Da)</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }

  function calculate() {
    try {
      const tables = getTables();
      const deltas = {
        waterLoss: Number(waterLossEl.value),
        psDelta: Number(psDeltaEl.value),
        ome: Number(omeDeltaEl.value)
      };

      if ([deltas.waterLoss, deltas.psDelta, deltas.ome].some(v => Number.isNaN(v))) {
        throw new Error('Numeric fields must be valid numbers');
      }

      const { tokens, psMarkers } = parseSequence(seqEl.value || '', tables, deltas);
      const totals = computeMW(tokens, psMarkers, deltas);
      const extinction = computeExtinction(tokens);
      setStatus('OK', true);
      resultEl.textContent = `Molecular weight: ${totals.total.toFixed(3)} Da`;
      extResultEl.textContent = `Extinction coefficient: ${extinction.toFixed(0)} M⁻¹ cm⁻¹`;
      renderBreakdown(tokens, psMarkers, totals, deltas, extinction);
      renderDeletionAnalysis(tokens, psMarkers, totals, deltas);
    } catch (err) {
      setStatus(err.message, false);
      resultEl.textContent = 'Molecular weight: –';
      extResultEl.textContent = 'Extinction coefficient: –';
      breakdownEl.innerHTML = '';
      summaryEl.textContent = '';
      deletionEl.innerHTML = '';
    }
  }

  document.getElementById('calculate').addEventListener('click', calculate);
  initDefaults();
  calculate();
</script>
</body>
</html>
